<!-- FILE: src/app/templates/parcels.html -->
{% extends "base.html" %}
{% block content %}
<h2>Посылки</h2>

<form id="createForm">
  <fieldset>
    <legend>Добавить посылку (async / очередь)</legend>
    <label>Название <input name="name" required></label>
    <label>Вес, кг <input name="weight_kg" type="number" step="0.001" value="1.0" required></label>
    <label>Тип ID <input name="type_id" type="number" value="1" required></label>
    <label>Содержимое, $ <input name="content_usd" type="number" step="0.01" value="100" required></label>
    <button type="submit">Создать</button>
  </fieldset>
</form>

<p class="muted">Синхронная регистрация: POST <code>/api/v1/parcels/register-sync</code>.</p>

<table id="list">
  <thead>
    <tr>
      <th>public_id</th>
      <th>Название</th>
      <th>Тип</th>
      <th>Вес</th>
      <th>Содержимое $</th>
      <th>Стоимость ₽</th>
      <th>Компания</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function load() {
  const r = await fetch('/api/v1/parcels?page=1&per_page=50');
  if (!r.ok) {
    alert('Не удалось получить список: ' + r.status);
    return;
  }
  const body = await r.json();
  const data = body.ok ? body.result : body;
  const items = Array.isArray(data.items) ? data.items : (data.result?.items || []);
  const tb = document.querySelector('#list tbody');
  tb.innerHTML = '';
  for (const it of items) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.public_id}</td>
      <td>${it.name}</td>
      <td>${it.type_name} (#${it.type_id})</td>
      <td>${it.weight_kg}</td>
      <td>${it.content_usd}</td>
      <td>${it.cost_rub ?? "Не рассчитано"}</td>
      <td>${it.shipping_company_id ?? ""}</td>`;
    tb.appendChild(tr);
  }
}

document.getElementById('createForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: form.name.value,
    weight_kg: form.weight_kg.value,
    type_id: Number(form.type_id.value),
    content_usd: form.content_usd.value
  };
  const r = await fetch('/api/v1/parcels/register', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const body = await r.json().catch(()=>({}));
  if (r.ok && (body.ok ?? true)) {
    alert('Зарегистрировано: public_id=' + (body.result?.public_id || body.public_id));
    await load();
  } else {
    alert('Ошибка: ' + (body.detail || body.error?.message || r.status));
  }
});

load();
</script>
{% endblock %}
